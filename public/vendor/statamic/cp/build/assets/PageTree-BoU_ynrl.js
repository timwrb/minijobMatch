import{A as U,w as O,l as I}from"./index-CiZTVuMj.js";import{_ as z,g as A,D as N,h as E,r as i,i as L,d as g,o as l,j as m,f as o,k as h,w as y,c as x,l as d,t as _,n as v,m as T,p,q as j,s as M,v as V,u as P,x as R,y as K}from"./index-DmYaZOZj.js";const $={components:{Dropdown:E,DropdownMenu:N,Icon:A},props:{page:Object,depth:Number,root:Boolean,firstPageIsRoot:Boolean,isOpen:Boolean,hasChildren:Boolean,showBlueprint:Boolean,showSlugs:Boolean,editable:{type:Boolean,default:!0},stat:Object},data(){return{editing:!1}},computed:{isTopLevelBranch(){return this.depth===1},isRoot(){return this.root},isEntry(){return!!this.page.id},isLink(){return!this.page.id&&this.page.title&&this.page.url},isText(){return this.page.title&&!this.page.url},title(){return this.page.title||this.page.entry_title||this.page.url},slugPath(){return this.isRoot?"/":"/"+this.page.slug}},methods:{getStatusTooltip(){let e=__(this.page.status)||__("Text item");return e[0].toUpperCase()+e.slice(1)},remove(e){this.$emit("removed",this.stat,e)}}},q={key:0,class:"page-move w-6"},F={class:"flex flex-1 items-center p-1.5 text-xs leading-normal"},H=["href","textContent"],J={key:1,class:"pt-[2px] font-mono text-2xs text-gray-700 dark:text-gray-500"},G={key:3,class:"flex items-center gap-2"},Q=["href","textContent"],W=["href","textContent"],X={class:"flex items-center gap-3"};function Y(e,a,t,f,c,s){const C=i("ui-status-indicator"),b=i("ui-icon"),D=i("ui-button"),S=i("Icon"),w=i("ui-badge"),k=i("DropdownMenu"),B=i("Dropdown"),r=L("tooltip");return l(),g("div",{class:v(["page-tree-branch flex",{"page-tree-branch--has-children":t.hasChildren}])},[m(e.$slots,"branch-action",{branch:t.page},()=>[t.editable?(l(),g("div",q)):h("",!0)]),o("div",F,[o("div",{class:"flex gap-3 grow items-center",onClick:a[2]||(a[2]=n=>e.$emit("branch-clicked",t.page))},[y(d(C,{status:t.page.status},null,8,["status"]),[[r,s.getStatusTooltip()]]),s.isRoot?y((l(),x(b,{key:0,name:"home",class:"size-4"},null,512)),[[r,e.__("This is the root page")]]):h("",!0),o("a",{onClick:a[0]||(a[0]=T(n=>e.$emit("edit",n),["prevent"])),class:v({"text-sm font-medium is-top-level-branch":s.isTopLevelBranch}),href:t.page.edit_url,textContent:_(s.title)},null,10,H),t.showSlugs?(l(),g("span",J,_(s.slugPath),1)):h("",!0),t.hasChildren?(l(),x(D,{key:2,class:v(["transition duration-100 [&_svg]:size-4! -mx-1.5",{"-rotate-90 is-closed":!t.isOpen,"is-open":t.isOpen}]),icon:"chevron-down",size:"xs",round:"",variant:"ghost","aria-label":t.isOpen?e.__("Collapse"):e.__("Expand"),"aria-expanded":t.isOpen,onClick:a[1]||(a[1]=T(n=>e.$emit("toggle-open"),["stop"]))},null,8,["class","aria-label","aria-expanded"])):h("",!0),t.page.collection&&t.editable?(l(),g("div",G,[d(S,{name:"navigation",class:"size-3.5 text-gray-500"}),o("div",null,[o("a",{href:t.page.collection.create_url,textContent:_(e.__("Add")),class:"hover:text-blue-600"},null,8,Q),a[3]||(a[3]=o("span",{class:"mx-1 text-gray-400 dark:text-gray-500"},"/",-1)),o("a",{href:t.page.collection.edit_url,textContent:_(e.__("Edit")),class:"hover:text-blue-600"},null,8,W)])])):h("",!0)]),o("div",X,[t.showBlueprint&&t.page.entry_blueprint?y((l(),x(w,{key:0,text:e.__(t.page.entry_blueprint.title),size:"sm",variant:"filled"},null,8,["text"])),[[r,e.__("Blueprint")]]):h("",!0),m(e.$slots,"branch-icon",{branch:t.page}),d(B,{placement:"left-start",class:v({invisible:s.isRoot,hidden:!t.editable})},{default:p(()=>[d(k,null,{default:p(()=>[m(e.$slots,"branch-options",{branch:t.page,depth:t.depth,removeBranch:s.remove})]),_:3})]),_:3},8,["class"])])])],2)}const Z=z($,[["render",Y]]),ee={components:{Draggable:U,TreeBranch:Z,PanelHeader:M,Panel:j,Icon:A},props:{pagesUrl:{type:String,required:!0},submitUrl:{type:String},submitParameters:{type:Object,default:()=>({})},createUrl:{type:String},site:{type:String,required:!0},localizations:{type:Array},maxDepth:{type:Number,default:1/0},expectsRoot:{type:Boolean,required:!0},showSlugs:{type:Boolean,default:!1},preferencesPrefix:{type:String},editable:{type:Boolean,default:!0},blueprints:{type:Array}},data(){return{loading:!1,saving:!1,pages:[],treeData:[],collapsedState:[],discardingChanges:!1}},computed:{activeLocalization(){return this.localizations.find(e=>e.active)},preferencesKey(){return this.preferencesPrefix?`${this.preferencesPrefix}.${this.site}.pagetree`:null},direction(){return this.$config.get("direction","ltr")}},watch:{site(e){this.getPages()},collapsedState:{deep:!0,handler(e){this.preferencesKey&&localStorage.setItem(this.preferencesKey,JSON.stringify(e))}}},created(){this.collapsedState=this.getCollapsedState(),this.getPages().then(()=>{this.initialPages=K(this.pages)}),this.$keys.bindGlobal(["mod+s"],e=>{e.preventDefault(),this.save()})},methods:{isRoot(e){return this.expectsRoot?e.level===1&&e.data.id===this.treeData[0]?.id:!1},getPages(){this.loading=!0;const e=`${this.pagesUrl}?site=${this.site}`;return this.$axios.get(e).then(a=>{this.pages=a.data.pages,this.updateTreeData(),this.loading=!1})},treeUpdated(){this.pages=this.$refs.tree.getData(),this.$emit("changed")},cleanPagesForSubmission(e){return e.map(a=>({id:a.id,children:this.cleanPagesForSubmission(a.children)}))},save(){if(!this.editable)return;this.saving=!0;const e={pages:this.cleanPagesForSubmission(this.pages),site:this.site,expectsRoot:this.expectsRoot,...this.submitParameters};return this.$axios.patch(this.submitUrl,e).then(a=>a.data.saved?(this.$emit("saved",a),this.$toast.success(__("Saved")),this.initialPages=this.pages,a):this.$toast.error("Couldn't save tree")).catch(a=>{let t=a.response?a.response.data.message:__("Something went wrong");if(a.response&&a.response.status===422){const{errors:f}=a.response.data;t=f[Object.keys(f)[0]][0]}return this.$toast.error(t),Promise.reject(a)}).finally(()=>this.saving=!1)},addPages(e,a){this.$refs.tree.addMulti(e,a),this.treeUpdated()},updateTreeData(){this.treeData=[...this.pages]},pageRemoved(e,a){const t=[];a||e.children.forEach(f=>t.push({...f.data})),this.$refs.tree.batchUpdate(()=>{this.$refs.tree.remove(e),t.length&&this.$refs.tree.addMulti(t,e.parent)}),this.treeUpdated()},localizationSelected(e){e.active||(e.exists?this.editLocalization(e):this.createLocalization(e))},editLocalization(e){window.location=e.url},createLocalization(e){console.log("todo.")},cancel(){this.discardingChanges=!0},confirmDiscard(){this.pages=this.initialPages,this.updateTreeData(),this.$emit("canceled"),this.discardingChanges=!1},rootDroppable(){return this.expectsRoot?I.dragNode.children.length===0:!0},eachDroppable(e){return this.expectsRoot?!this.isRoot(e):!0},pageUpdated(){this.pages=this.$refs.tree.getData(),this.$emit("changed")},expandAll(){this.$refs.tree.openAll(),this.collapsedState=[]},collapseAll(){this.$refs.tree.closeAll(),this.collapsedState=[],O(this.treeData,e=>{this.collapsedState.push(e.id)})},getNodeByBranchId(e){let a;return O(this.treeData,t=>{if(t.id===e)return a=t,!1}),a},getCollapsedState(){return this.preferencesKey?JSON.parse(localStorage.getItem(this.preferencesKey)||"[]"):[]},nodeOpened(e){this.collapsedState.splice(this.collapsedState.indexOf(e.data.id),1)},nodeClosed(e){this.collapsedState.push(e.data.id)},statHandler(e){return e.open=!this.collapsedState.includes(e.data.id),e}}},te={key:0,class:"no-results flex w-full items-center"},ae={key:0,class:"loading card"},se={class:"page-tree-header font-medium text-sm items-center flex justify-between"},ne=["textContent"],ie={class:"flex gap-2"},re={key:1,class:"page-tree"};function oe(e,a,t,f,c,s){const C=i("Icon"),b=i("ui-button"),D=i("ui-panel-header"),S=i("tree-branch"),w=i("Draggable"),k=i("ui-panel"),B=i("confirmation-modal");return l(),g("div",null,[!c.loading&&c.treeData.length==0?(l(),g("div",te,[m(e.$slots,"empty")])):h("",!0),y(d(k,null,{default:p(()=>[c.loading?(l(),g("div",ae,[d(C,{name:"loading"})])):h("",!0),d(D,null,{default:p(()=>[o("div",se,[o("div",{textContent:_(e.__("Tree Structure"))},null,8,ne),o("div",ie,[d(b,{size:"sm",icon:"tree-collapse",text:e.__("Collapse"),onClick:s.collapseAll},null,8,["text","onClick"]),d(b,{size:"sm",icon:"tree-expand",text:e.__("Expand"),onClick:s.expandAll},null,8,["text","onClick"])])])]),_:1}),c.loading?h("",!0):(l(),g("div",re,[d(w,{ref:"tree",modelValue:c.treeData,"onUpdate:modelValue":a[0]||(a[0]=r=>c.treeData=r),"disable-drag":!t.editable,space:1,indent:24,dir:s.direction,"node-key":r=>r.data.id,dragOverThrottleInterval:30,"each-droppable":s.eachDroppable,"root-droppable":s.rootDroppable,"max-level":t.maxDepth,"stat-handler":s.statHandler,onAfterDrop:s.treeUpdated,"onOpen:node":s.nodeOpened,"onClose:node":s.nodeClosed},{placeholder:p(()=>a[2]||(a[2]=[o("div",{class:"w-full rounded-sm border border-dashed border-blue-400 bg-blue-500/10 p-2"},"Â ",-1)])),default:p(({node:r,stat:n})=>[d(S,{ref:`branch-${r.id}`,page:r,stat:n,depth:n.level,"first-page-is-root":t.expectsRoot,"is-open":n.open,"has-children":n.children.length>0,"show-slugs":t.showSlugs,"show-blueprint":t.blueprints?.length>1,editable:t.editable,root:s.isRoot(n),onEdit:u=>e.$emit("edit-page",r,u),onToggleOpen:u=>n.open=!n.open,onRemoved:s.pageRemoved,onBranchClicked:u=>e.$emit("branch-clicked",r),class:"mb-px"},{"branch-action":p(u=>[m(e.$slots,"branch-action",P(R({...u,stat:n})))]),"branch-icon":p(u=>[m(e.$slots,"branch-icon",P(R({...u,stat:n})))]),"branch-options":p(u=>[m(e.$slots,"branch-options",P(R({...u,stat:n})))]),_:2},1032,["page","stat","depth","first-page-is-root","is-open","has-children","show-slugs","show-blueprint","editable","root","onEdit","onToggleOpen","onRemoved","onBranchClicked"])]),_:3},8,["modelValue","disable-drag","dir","node-key","each-droppable","root-droppable","max-level","stat-handler","onAfterDrop","onOpen:node","onClose:node"])]))]),_:3},512),[[V,c.treeData.length]]),c.discardingChanges?(l(),x(B,{key:1,title:e.__("Discard Changes"),"body-text":e.__("Are you sure?"),"button-text":e.__("Discard Changes"),danger:!0,onConfirm:s.confirmDiscard,onCancel:a[1]||(a[1]=r=>c.discardingChanges=!1)},null,8,["title","body-text","button-text","onConfirm"])):h("",!0)])}const ce=z(ee,[["render",oe]]);export{ce as default};
